# MOEX Data Fetcher

Асинхронное приложение для получения данных о ценах акций с Московской биржи с кэшированием в PostgreSQL.

## Возможности

- Асинхронное получение данных о ценах акций за указанный период
- Кэширование данных в PostgreSQL для ускорения повторных запросов
- Поддержка множественных тикеров в одном запросе
- Параллельная обработка запросов к API
- Валидация входных данных с помощью Pydantic
- REST API на FastAPI

## Технологии

- Python 3.11
- FastAPI (асинхронный)
- PostgreSQL
- SQLAlchemy (асинхронный)
- Pydantic
- aiohttp (асинхронные HTTP запросы)
- asyncpg (асинхронный драйвер PostgreSQL)
- Alembic (миграции)
- Poetry (управление зависимостями)

## Установка

1. Клонируйте репозиторий:
```bash
git clone <repository-url>
cd moex_fetch
```

2. Установите Poetry (если не установлен):
```bash
pip install poetry
```

3. Установите зависимости:
```bash
poetry install
```

4. Создайте файл `.env` на основе `env.example`:
```bash
cp env.example .env
```

5. Настройте подключение к базе данных в файле `.env`

6. Создайте базу данных PostgreSQL:
```sql
CREATE DATABASE moex_data;
```

7. Примените миграции:
```bash
poetry run alembic upgrade head
```

## Запуск

```bash
# Способ 1: Через run.py
python run.py

# Способ 2: Через uvicorn напрямую
poetry run uvicorn engine.app:app --reload
```

Приложение будет доступно по адресу: http://localhost:8000

## API Endpoints

### POST /fetch-stock-data

Получение данных о ценах акций.

**Параметры запроса:**
```json
{
  "tickers": ["SBER", "GAZP"],
  "start_date": "2024-01-01",
  "end_date": "2024-01-31"
}
```

**Ответ:**
```json
{
  "SBER": {
    "2024-01-01": 250.5,
    "2024-01-02": 251.2,
    "2024-01-03": 249.8
  },
  "GAZP": {
    "2024-01-01": 150.1,
    "2024-01-02": 151.3,
    "2024-01-03": 149.9
  }
}
```

### GET /health

Проверка состояния приложения.

### GET /

Информация о приложении.

## Структура проекта

```
moex_fetch/
├── run.py                    # Скрипт запуска приложения
├── database/                 # Подключение к базе данных
│   ├── __init__.py
│   └── database.py          # Асинхронное подключение к БД
├── models/                   # Модели SQLAlchemy и Pydantic
│   ├── __init__.py
│   ├── stock_data.py        # Модель данных акций
│   └── pydantic_models.py   # Pydantic модели
├── engine/                   # Бизнес-логика и приложение
│   ├── __init__.py
│   ├── app.py               # Основное FastAPI приложение
│   ├── moex_client.py       # Асинхронный клиент MOEX API
│   └── data_service.py      # Асинхронный сервис работы с данными
├── alembic/                  # Миграции базы данных
│   ├── env.py
│   ├── script.py.mako
│   └── versions/
├── pyproject.toml           # Конфигурация Poetry
├── alembic.ini              # Конфигурация Alembic
├── env.example              # Пример переменных окружения
└── README.md                # Документация
```

## Использование

1. Запустите приложение
2. Отправьте POST запрос на `/fetch-stock-data` с JSON телом
3. Получите данные о ценах акций в формате словаря

## Особенности

- **Асинхронность**: Все операции с базой данных и API выполняются асинхронно
- **Параллельная обработка**: Несколько тикеров обрабатываются одновременно
- **Кэширование**: Данные сохраняются в PostgreSQL для ускорения повторных запросов
- **Автоматическое получение**: Приложение автоматически получает недостающие данные с MOEX API
- **Валидация**: Поддерживается до 10 тикеров в одном запросе
- **Обработка ошибок**: Валидация дат и тикеров с понятными сообщениями об ошибках

## Асинхронные преимущества

1. **Высокая производительность**: Множественные запросы к API выполняются параллельно
2. **Масштабируемость**: Приложение может обрабатывать множество одновременных запросов
3. **Эффективность**: Неблокирующие операции с базой данных и внешними API
4. **Ресурсоэффективность**: Меньшее потребление памяти и CPU

## Разработка

### Создание миграции:
```bash
poetry run alembic revision --autogenerate -m "Описание изменений"
```

### Применение миграций:
```bash
poetry run alembic upgrade head
```

### Запуск тестов:
```bash
poetry run pytest
```

### Форматирование кода:
```bash
poetry run black .
```

## Примеры использования

### Получение данных по одному тикеру:
```bash
curl -X POST "http://localhost:8000/fetch-stock-data" \
     -H "Content-Type: application/json" \
     -d '{
       "tickers": ["SBER"],
       "start_date": "2024-01-01",
       "end_date": "2024-01-10"
     }'
```

### Получение данных по нескольким тикерам:
```bash
curl -X POST "http://localhost:8000/fetch-stock-data" \
     -H "Content-Type: application/json" \
     -d '{
       "tickers": ["SBER", "GAZP", "LKOH"],
       "start_date": "2024-01-01",
       "end_date": "2024-01-31"
     }'
``` 